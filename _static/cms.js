lyahcms="http://lyahcms.appspot.com";jQuery.prototype.cssShadow=function(a){this.css("-moz-box-shadow",a).css("-webkit-box-shadow",a).css("box-shadow",a);return this};jQuery.prototype.cssBorderRadius=function(a){this.css("-moz-border-radius",a).css("border-radius",a);return this};var CommentsSystem=function(){this.ccounts={};this.isCCInitialized=!1;this.selectedPara=null;this.setup()};CommentsSystem.prototype.group=function(){return/^.*\/(.*)\.html$/i.exec(location.pathname)[1]}();
CommentsSystem.prototype.select=function(a){if(this.selectedPara)this.selectedPara.onUnselect();this.selectedPara=a;a.onSelect()};CommentsSystem.prototype.unselect=function(){if(this.selectedPara)this.selectedPara.onUnselect();this.selectedPara=null};CommentsSystem.prototype.setup=function(){var a=this;$("img").css("position","relative").css("z-index","69");$(".body p").not(".admonition-title").each(function(b){new Paragraph(a,b,this)})};
CommentsSystem.prototype.postComment=function(a,b,c){var d=this;$.getJSON(lyahcms+"/post?callback=?",{group:this.group,thread:a,author:b.author,url:b.url,text:b.text},function(a){a.success&&d.updateCommentsCount();c(a.success)})};CommentsSystem.prototype.updateCommentsCount=function(a){var b=this;$.getJSON(lyahcms+"/count?callback=?",{group:this.group},function(c){b.ccounts=c.success?c.count:{};a&&a()})};
CommentsSystem.prototype.withCommentCount=function(a,b){var c=this;this.isCCInitialized?b(this.ccounts[a]||0):this.updateCommentsCount(function(){c.isCCInitialized=!0;b(c.ccounts[a]||0)})};CommentsSystem.prototype.withComments=function(a,b){$.getJSON(lyahcms+"/comments?callback=?",{group:this.group,thread:a},function(a){if(a.success){var d=[];$.each(a.cs,function(a,b){d.push(new Comment(b))});b(d)}})};
var Comment=function(a){this.author=unescape(a.author);this.url=a.url;this.date=decodeURI(a.date);this.text=unescape(a.text)};Comment.prototype.attach=function(a){a.append('<div class="comment"><h5>'+(this.url?'<a href="'+this.url+'">'+this.author+"</a>":this.author)+"</h5><h6>"+this.date+"</h6><pre>"+this.text+"</pre></div>")};var CommentsBox=function(a,b){this.comments=[];this.cs=a;this.para=b;this.wrapper=null;this.form=new Form(a,this);this.attach()};
CommentsBox.prototype.attach=function(){this.para.contents.append('<div class="comments"></div>');this.wrapper=this.para.contents.find(".comments");this.wrapper.css("padding","3ex 6ex 1ex 6ex");this.wrapper.hide()};CommentsBox.prototype.loadComments=function(a){var b=this;this.cs.withComments(this.para.thread,function(c){b.comments=c;$.each(c,function(a,c){c.attach(b.wrapper)});b.setupStyle();a&&a()})};
CommentsBox.prototype.onSubmit=function(){var a=this;this.cs.postComment(this.para.thread,this.form.getComment(),function(){a.cs.unselect()})};
CommentsBox.prototype.setupStyle=function(){this.wrapper.find(".comment").css("background-color","#ffe1fa").cssBorderRadius("10px").cssShadow("0 0 3px 3px #ffe1fa").css("margin-top","2ex");this.wrapper.find("h5").css("color","#555").css("margin-bottom","0");this.wrapper.find("a").css("color","#555");this.wrapper.find("h6").css("font-size","x-small").css("color","#555").css("line-height","0");this.wrapper.find("pre").css("text-indent",0).css("font-size","small").css("font-family",'Consolas, "Courier New", monospace').css("color",
"#5A5A5A").css("line-height","2ex").css("padding","2ex 0 0 6ex").css("white-space","pre-wrap").css("white-space","-moz-pre-wrap").css("white-space","-pre-wrap").css("white-space","-o-pre-wrap")};CommentsBox.prototype.show=function(){var a=this;this.loadComments(function(){a.form.show();a.wrapper.slideDown("fast")})};CommentsBox.prototype.hide=function(){var a=this;this.wrapper.slideUp("fast",function(){a.form.hide();a.wrapper.empty()})};
var Form=function(a,b){this.cs=a;this.csBox=b;this.form=null;this.isSubmited=!1};Form.prototype.src='<div class="cmtform"><h4>\u00a1Comentar es gratis!</h4><form><p><input type="text" name="author_name" id="author_name" size="40" tabindex="1"><label id="anlabel" for="author_name">Nombre (obligatorio)</label></p><p><input type="text" name="author_url" id="author_url" size="40" tabindex="2"><label id="aulabel" for="author_url">P\u00e1gina web (opcional, incluir protocolo ("http:\\\\", "https:\\\\"))</label><p/><p><textarea name="text" id="cmttext" rows="7" cols="60" tabindex="3"></textarea><p/><p><input type="submit"id="submit" tabindex="4" value="Enviar"></p></form></div>';
Form.prototype.getComment=function(){return new Comment({author:escape(this.form.find("#author_name").val()),url:encodeURI(this.form.find("#author_url").val()),text:escape(this.form.find("#cmttext").val())})};Form.prototype.hide=function(){this.form.remove();this.form=null};
Form.prototype.setup=function(){var a=this,b=this.form.find("#submit");this.isSubmited=!1;this.form.css("display","block").css("border-top","solid 1px #AAA").css("margin-top","2ex");this.form.find("h4").css("color","#555").css("text-indent","0");this.form.find("p").css("text-indent","0").css("font-size","small").css("color","#555").css("padding","0").css("margin","0");this.form.find("label").css("padding-left","1ex");b.css("margin-top","1ex");b.click(function(b){b.preventDefault();if(!a.isSubmited)a.isSubmited=
!0,a.csBox.onSubmit()})};Form.prototype.show=function(){this.csBox.wrapper.append(this.src);this.form=this.csBox.wrapper.find(".cmtform");this.setup()};var Paragraph=function(a,b,c){var d=this;this.contents=$(c);this.cs=a;this.isHover=!1;this.thread=b;this.toggle=new Toggle(a,this);this.csBox=new CommentsBox(a,this);this.attach();this.setDefaultStyle();a.withCommentCount(b,function(a){a!==0&&(d.contents.append('<div class="ccount"><p>'+a+"</p></div>"),d.setCountStyle())})};
Paragraph.prototype.attach=function(){var a=this;this.contents.wrap('<div class="par-wrapper">');this.contents=this.contents.parent();this.contents.hover(function(){a.onHoverIn()},function(){a.onHoverOut()})};Paragraph.prototype.isSelected=function(){return this.thread===(this.cs.selectedPara?this.cs.selectedPara.thread:-1)};Paragraph.prototype.onHoverIn=function(){if(!this.isSelected())this.isHover=!0,this.setBackground("#ffe1fa"),this.toggle.show()};
Paragraph.prototype.onHoverOut=function(){if(!this.isSelected())this.isHover=!1,this.setBackground("transparent"),this.toggle.hide()};Paragraph.prototype.onSelect=function(){this.setBackground("#fff1fd");this.toggle.hide();this.csBox.show()};Paragraph.prototype.onUnselect=function(){this.setBackground("transparent");this.csBox.hide()};Paragraph.prototype.setBackground=function(a){this.contents.css("background-color",a).cssShadow("0 0 5px 5px "+a)};
Paragraph.prototype.setDefaultStyle=function(){this.contents.css("position","relative").cssBorderRadius("10px")};Paragraph.prototype.setCountStyle=function(){$(this.contents.find(".ccount")[0]).css("height","42px").css("width","43px").css("background-image",'url("../_static/count.png")').css("position","absolute").css("top","0").css("left","-40px");$(this.contents.find(".ccount p")[0]).css("font-size","10px").css("margin","11px 0 0 7px").css("width","25px")};
var Toggle=function(a,b){this.cs=a;this.link=null;this.para=b;this.wrapper=null;this.isClicked=this.isAttached=!1};Toggle.prototype.setLabel=function(){var a=this;this.cs.withCommentCount(this.para.thread,function(b){a.link.text(b===0?"Sin comentarios":b===1?"1 Comentario":b+" Comentarios")})};
Toggle.prototype.setup=function(){var a=this;this.para.contents.prepend('<div class="toggle"><a>Cargando...</a></div>');this.wrapper=this.para.contents.find(".toggle");this.link=this.para.contents.find(".toggle a");this.setupStyle();this.link.click(function(b){b.preventDefault();if(!a.isClicked)a.isClicked=!0,a.cs.select(a.para),a.link.text("Cargando...")})};
Toggle.prototype.setupStyle=function(){var a=this.para.contents.width()/2-this.link.width()/2,b=this.para.contents.height()/2-this.wrapper.height();this.wrapper.css("position","absolute").css("display","none").css("background-color","rgba(230,230,230,0.9)").css("border","solid 1px rgba(40,40,40,0.6)").css("border-bottom","solid 1px rgba(40,40,40,0.75)").css("border-top","solid 1px rgba(40,40,40,0.3)").css("cursor","pointer").css("padding","0 5px 0 5px").cssShadow("0 0 2px 2px rgba(60,60,60,0.25)").cssBorderRadius("10px").css("top",
b+"px").css("left",a+"px");this.link.css("color","#222").css("text-decoration","none").css("text-shadow","0px 1px 1px rgba(255,255,255,1)")};Toggle.prototype.show=function(){var a=this;if(!this.isAttached)this.setup(),this.isAttached=!0;this.setLabel();this.wrapper.fadeIn("slow",function(){a.para.isHover||a.hide()})};Toggle.prototype.hide=function(){this.wrapper.hide();this.isClicked=!1};$(function(){CommentsSystem.prototype.instance=new CommentsSystem});